#!/bin/bash

# Helm Schema Plugin
# Wrapper script for helm-schema CLI tool

set -e

usage() {
    echo "Generate JSON Schema for Helm chart values"
    echo ""
    echo "Usage:"
    echo "  helm schema <chart-path> [flags]"
    echo ""
    echo "Examples:"
    echo "  helm schema ./my-chart                    # Generate schema for chart"
    echo "  helm schema ./my-chart --no-subcharts    # Skip subchart parsing"
    echo "  helm schema https://example.com/chart.tgz # Generate schema from remote chart"
    echo ""
    echo "Flags:"
    "$BINARY" --help 2>&1 | grep -E "^\s*-"
}

# Use the bundled binary from the plugin directory
BINARY="$HELM_PLUGIN_DIR/helm-schema"

# Check if the bundled binary exists
if [[ ! -f "$BINARY" ]]; then
    echo "Error: helm-schema binary not found in plugin directory" >&2
    echo "" >&2
    echo "Expected binary at: $BINARY" >&2
    echo "This indicates the plugin was not installed with the binary." >&2
    echo "" >&2
    echo "Please reinstall the plugin with the binary included." >&2
    exit 1
fi

# Make sure binary is executable
[[ ! -x "$BINARY" ]] && chmod +x "$BINARY"

[[ "$1" == "-h" || "$1" == "--help" ]] && usage && exit 0
[[ $# -eq 0 ]] && echo "Error: chart path is required" >&2 && usage && exit 1

# Check if first argument is a URL (remote chart)
CHART_PATH="$1"
if [[ "$CHART_PATH" =~ ^https?:// ]]; then
    # Handle remote chart by downloading to temp directory
    TEMP_DIR=$(mktemp -d)
    trap "rm -rf $TEMP_DIR" EXIT
    
    echo "Downloading remote chart..." >&2
    if command -v curl &> /dev/null; then
        curl -L -o "$TEMP_DIR/chart.tgz" "$CHART_PATH"
    elif command -v wget &> /dev/null; then
        wget -O "$TEMP_DIR/chart.tgz" "$CHART_PATH"
    else
        echo "Error: neither curl nor wget found. Cannot download remote chart." >&2
        exit 1
    fi
    
    # Extract the chart
    cd "$TEMP_DIR"
    tar -xzf chart.tgz
    
    # Find the extracted chart directory (should be the only directory)
    EXTRACTED_CHART=$(find . -maxdepth 1 -type d ! -name . | head -n 1)
    if [[ -z "$EXTRACTED_CHART" ]]; then
        echo "Error: Could not find chart directory in downloaded archive" >&2
        exit 1
    fi
    
    # Update arguments to use extracted chart path
    shift
    set -- "$TEMP_DIR/$EXTRACTED_CHART" "$@"
fi

OUTFILE="values.schema.json"
exec "$BINARY" "$@" > "$CHART_PATH/$OUTFILE"